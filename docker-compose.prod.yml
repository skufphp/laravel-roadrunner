services:
  # Настройки RoadRunner для Production (использование образов из Registry)
  laravel-roadrunner:
    image: "${CI_REGISTRY_IMAGE}/app:${IMAGE_TAG}"
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      APP_BASE_PATH: /var/www/laravel
      RR_HTTP_NUM_WORKERS: ${RR_HTTP_NUM_WORKERS:-8}
      RR_LOG_LEVEL: ${RR_LOG_LEVEL:-warn}

  # Queue Worker — обработка очередей Laravel
  laravel-queue-rr:
    image: "${CI_REGISTRY_IMAGE}/app:${IMAGE_TAG}"
    container_name: laravel-queue-rr
    restart: unless-stopped
    working_dir: /var/www/laravel
    env_file:
      - .env
    command: ["php", "artisan", "queue:work", "--sleep=3", "--tries=3", "--max-time=3600"]
    networks:
      - laravel-roadrunner-network
    depends_on:
      laravel-redis-rr:
        condition: service_healthy
    environment:
      APP_BASE_PATH: /var/www/laravel
    healthcheck:
      test: ["CMD-SHELL", "php artisan queue:monitor default --max=100 || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Scheduler — планировщик задач Laravel (cron)
  laravel-scheduler-rr:
    image: "${CI_REGISTRY_IMAGE}/app:${IMAGE_TAG}"
    container_name: laravel-scheduler-rr
    restart: unless-stopped
    working_dir: /var/www/laravel
    environment:
      APP_BASE_PATH: /var/www/laravel
    command: ["sh", "-c", "while true; do php artisan schedule:run --verbose --no-interaction; sleep 60; done"]
    networks:
      - laravel-roadrunner-network
    depends_on:
      laravel-postgres-rr:
        condition: service_healthy

  # Сервис для автоматического запуска миграций при деплое
  migrate:
    image: "${CI_REGISTRY_IMAGE}/app:${IMAGE_TAG}"
    restart: "no"
    working_dir: /var/www/laravel
    environment:
      APP_BASE_PATH: /var/www/laravel
    command: ["sh", "-lc", "php artisan migrate --force"]
    depends_on:
      laravel-postgres-rr:
        condition: service_healthy
    networks:
      - laravel-roadrunner-network
